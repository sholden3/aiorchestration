<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Governance Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: auto;
        }
        
        .status-active {
            background: #10b981;
            color: white;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #6b7280;
            font-size: 14px;
        }
        
        .metric-value {
            font-weight: 600;
            color: #333;
        }
        
        .severity-critical { color: #dc2626; }
        .severity-high { color: #ea580c; }
        .severity-medium { color: #ca8a04; }
        .severity-low { color: #0891b2; }
        .severity-info { color: #6b7280; }
        
        .events-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .event {
            padding: 10px;
            border-left: 3px solid #e5e7eb;
            margin-bottom: 10px;
            background: #f9fafb;
            border-radius: 5px;
        }
        
        .event.critical {
            border-left-color: #dc2626;
            background: #fef2f2;
        }
        
        .event.high {
            border-left-color: #ea580c;
            background: #fff7ed;
        }
        
        .event-time {
            font-size: 12px;
            color: #9ca3af;
        }
        
        .event-message {
            margin-top: 5px;
            color: #333;
        }
        
        .health-score {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        
        .health-good { color: #10b981; }
        .health-warning { color: #f59e0b; }
        .health-critical { color: #ef4444; }
        
        .chart-container {
            height: 200px;
            margin-top: 20px;
        }
        
        .bar {
            display: inline-block;
            width: 30px;
            margin-right: 5px;
            background: #667eea;
            vertical-align: bottom;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        button:hover {
            background: #764ba2;
        }
        
        .phase-selector {
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            background: white;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                üõ°Ô∏è Governance Dashboard
                <span class="status-badge status-active" id="status">ACTIVE</span>
            </h1>
        </header>
        
        <div class="controls">
            <button onclick="refreshData()">üîÑ Refresh</button>
            <select class="phase-selector" id="phaseSelector" onchange="changePhase()">
                <option value="1">Phase 1: Learning</option>
                <option value="2" selected>Phase 2: Advisory</option>
                <option value="3">Phase 3: Enforcement</option>
                <option value="4">Phase 4: Mature</option>
            </select>
            <button onclick="generateReport('daily')">üìä Daily Report</button>
            <button onclick="streamEvents()">üì° Live Stream</button>
        </div>
        
        <div class="dashboard-grid">
            <div class="card">
                <h2>üéØ Health Score</h2>
                <div class="health-score" id="healthScore">--</div>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value" id="healthStatus">Loading...</span>
                </div>
            </div>
            
            <div class="card">
                <h2>üìä Violations (24h)</h2>
                <div id="violationsMetrics">
                    <div class="metric loading">
                        <span class="metric-label">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>üß™ Test Status</h2>
                <div id="testMetrics">
                    <div class="metric loading">
                        <span class="metric-label">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>üìà Trend (7 days)</h2>
                <div class="chart-container" id="trendChart"></div>
            </div>
        </div>
        
        <div class="card">
            <h2>üìù Recent Events</h2>
            <div class="events-list" id="eventsList">
                <div class="event loading">Loading events...</div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8001/api/v1';
        let eventSource = null;
        
        async function fetchMetrics() {
            try {
                const response = await fetch(`${API_BASE}/metrics`);
                const data = await response.json();
                
                // Update health score
                const healthScore = document.getElementById('healthScore');
                const healthStatus = document.getElementById('healthStatus');
                healthScore.textContent = data.governance_health;
                
                if (data.governance_health >= 80) {
                    healthScore.className = 'health-score health-good';
                    healthStatus.textContent = 'Healthy';
                } else if (data.governance_health >= 60) {
                    healthScore.className = 'health-score health-warning';
                    healthStatus.textContent = 'Warning';
                } else {
                    healthScore.className = 'health-score health-critical';
                    healthStatus.textContent = 'Critical';
                }
                
                // Update violations
                const violationsDiv = document.getElementById('violationsMetrics');
                violationsDiv.innerHTML = '';
                
                const severities = ['critical', 'high', 'medium', 'low', 'info'];
                severities.forEach(severity => {
                    const count = data.violations_by_severity[severity] || 0;
                    const metric = document.createElement('div');
                    metric.className = 'metric';
                    metric.innerHTML = `
                        <span class="metric-label">${severity.charAt(0).toUpperCase() + severity.slice(1)}</span>
                        <span class="metric-value severity-${severity}">${count}</span>
                    `;
                    violationsDiv.appendChild(metric);
                });
                
                // Update test metrics
                const testDiv = document.getElementById('testMetrics');
                testDiv.innerHTML = '';
                
                if (data.test_status.has_runs) {
                    const lastRun = data.test_status.last_run;
                    testDiv.innerHTML = `
                        <div class="metric">
                            <span class="metric-label">Last Run</span>
                            <span class="metric-value">${lastRun.timestamp || 'Never'}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Coverage</span>
                            <span class="metric-value">${lastRun.coverage || 0}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Pass Rate</span>
                            <span class="metric-value">${calculatePassRate(lastRun)}%</span>
                        </div>
                    `;
                } else {
                    testDiv.innerHTML = `
                        <div class="metric">
                            <span class="metric-label">Status</span>
                            <span class="metric-value">No test runs recorded</span>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Failed to fetch metrics:', error);
            }
        }
        
        async function fetchEvents() {
            try {
                const response = await fetch(`${API_BASE}/events?limit=20`);
                const data = await response.json();
                
                const eventsList = document.getElementById('eventsList');
                eventsList.innerHTML = '';
                
                if (data.events.length === 0) {
                    eventsList.innerHTML = '<div class="event">No recent events</div>';
                    return;
                }
                
                data.events.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `event ${event.severity.toLowerCase()}`;
                    
                    const time = new Date(event.timestamp).toLocaleTimeString();
                    eventDiv.innerHTML = `
                        <div class="event-time">${time} - ${event.event_type}</div>
                        <div class="event-message">${event.message}</div>
                    `;
                    
                    eventsList.appendChild(eventDiv);
                });
                
            } catch (error) {
                console.error('Failed to fetch events:', error);
            }
        }
        
        async function changePhase() {
            const selector = document.getElementById('phaseSelector');
            const phase = parseInt(selector.value);
            
            try {
                const response = await fetch(`${API_BASE}/config/phase`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phase })
                });
                
                if (response.ok) {
                    alert(`Governance phase changed to ${phase}`);
                    refreshData();
                }
            } catch (error) {
                console.error('Failed to change phase:', error);
            }
        }
        
        async function generateReport(type) {
            try {
                const response = await fetch(`${API_BASE}/report/${type}`);
                const report = await response.json();
                
                // Download as JSON
                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `governance_${type}_report_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
            } catch (error) {
                console.error('Failed to generate report:', error);
            }
        }
        
        function streamEvents() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                alert('Live stream stopped');
                return;
            }
            
            eventSource = new EventSource(`${API_BASE}/stream/events`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // Add new event to top of list
                const eventsList = document.getElementById('eventsList');
                const eventDiv = document.createElement('div');
                eventDiv.className = `event ${data.severity.toLowerCase()}`;
                
                const time = new Date(data.timestamp).toLocaleTimeString();
                eventDiv.innerHTML = `
                    <div class="event-time">${time} - ${data.event_type} [LIVE]</div>
                    <div class="event-message">${data.message}</div>
                `;
                
                eventsList.insertBefore(eventDiv, eventsList.firstChild);
                
                // Keep only last 20 events
                while (eventsList.children.length > 20) {
                    eventsList.removeChild(eventsList.lastChild);
                }
            };
            
            alert('Live stream started - new events will appear in real-time');
        }
        
        function calculatePassRate(testRun) {
            if (!testRun.passed && !testRun.failed) return 0;
            const total = testRun.passed + testRun.failed;
            return total > 0 ? Math.round((testRun.passed / total) * 100) : 0;
        }
        
        function refreshData() {
            fetchMetrics();
            fetchEvents();
        }
        
        // Initial load
        refreshData();
        
        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>